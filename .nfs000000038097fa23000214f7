#!/bin/bash

NAME=$1
mkdir -p output_results/

# checking if the required programs are installed
if ! [ -x "$(command -v blastn)" ]; then
 	echo 'Error: blast is not installed or not included in the path.' >&2
 	exit 1
fi

if ! [ -x "$(command -v cd-hit-est)" ]; then
 	echo 'Error: CD-HIT is not installed or not included in the path.' >&2
 	exit 1
fi

if ! [ -x "$(command -v bedtools)" ]; then
 	echo 'Error: bedtools is not installed or not included in the path.' >&2
 	exit 1
fi


# extracting ffn and scaffolds.fasta files from gff files

for file in ./*.gff
do
	file_start=`echo ${file} | sed 's/\.gff//'`
	awk '/##FASTA/,0{if (!/##FASTA/)print}' < $file > ${file_start}.fasta
	
	sed '/##FASTA/Q' < $file | grep -v "##" > ${file_start}_temp.tsv
	cat ${file_start}_temp.tsv | awk -F'\t' '{print $1, $4, $5}' | tr " " "\t" > tmp00	
	cat ${file_start}_temp.tsv | awk -F'ID=' '{print $2}' | sed -e 's/;.*//' > tmp01
	cat ${file_start}_temp.tsv | awk -F'product=' '{print $2}' | sed -e 's/;.*//' | tr " " "_" > tmp02

	paste tmp01 tmp02 -d _ > tmp03
	paste tmp00 tmp03 -d '\t'  > ${file_start}.bed
	
	bedtools getfasta -fi ${file_start}.fasta -bed ${file_start}.bed -fo ${file_start}.ffn -name	
	rm -f tmp00 tmp01 tmp02 tmp03 ${file_start}.bed ${file_start}_temp.tsv

done

# creating a file of all the genes and clustering it with cd-hit-est
ALLGENES=output_results/all_genes_${NAME}
ls *.ffn > output_results/sample_list.txt

sed -i "s/.ffn//g" output_results/sample_list.txt

cat *.ffn > ${ALLGENES}

#sed -i "s/ /_/g" ${ALLGENES}

CLUSTERED=output_results/clustered_genes_${NAME}.ffn

echo -en "-----CLUSTERING WITH CD-HIT-EST-----\n"

cd-hit-est -T 12 -i ${ALLGENES} -o ${CLUSTERED} -M 0 -G 0 -d 200 -aS 0.8 -c 0.90

rm -f output_results/all_genes_${NAME}

# blast each sequence to the clustered database

echo -en "-----FINDING THE BEST ALIGNMENT FOR EACH GENE SEQUENCE-----\n"
gene_db_alignment_against_seq.sh  ${NAME}

echo -en "-----CREATING GENE PRESENCE/ABSENCE MATRIX-----\n"
convert_gene_alignment_to_binary.sh  ${NAME}

echo -en "-----THE ANALYSIS IS DONE-----\n"

rm -f *.fasta 
rm -f *.fasta.fai
rm -f *.ffn

